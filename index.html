<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NENWA - Quantum Recipes & Budget Tracker</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.js"></script>
<link rel="icon" href="NENWA.png">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Exo+2:wght@300;500&display=swap" rel="stylesheet">

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#9d00ff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="NENWA.png">

<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />

<style>
/* 全局样式 */
body {
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(180deg, #0a0a20 0%, #1a1a3a 100%);
    color: #fff;
    opacity: 0;
    transition: opacity 0.5s ease;
}

body.loaded {
    opacity: 1;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 10, 32, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 99999;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #9d00ff;
    border-top: 5px solid #00f0ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 量子樱花特效 */  
.sakura-container {  
    position: fixed;  
    top: 0;  
    left: 0;  
    width: 100%;  
    height: 100%;  
    pointer-events: none;  
    z-index: 9999;  
}  

.sakura {  
    position: absolute;  
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%239d00ff" d="M12 2C13.1 2 14 2.9 14 4S13.1 6 12 6 10 5.1 10 4 10.9 2 12 2m3.5 6.5c.3-.8 1.2-1.2 2-.9.8.3 1.2 1.2.9 2-.3.8-1.2 1.2-2 .9-.8-.3-1.2-1.2-.9-2zM7 12c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m11.5-1.5c.8-.3 1.7.1 2 .9.3.8-.1 1.7-.9 2-.8.3-1.7-.1-2-.9-.3-.8.1-1.7.9-2z"/></svg>');  
    width: 24px;  
    height: 24px;  
    animation: fall linear infinite, glow 2s ease-in-out infinite alternate;
    animation-duration: var(--duration, 10s);
    animation-delay: var(--delay, 0s);
    filter: drop-shadow(0 0 5px #9d00ff);
}

@keyframes fall {
    to { 
        transform: translateY(100vh) rotate(360deg);
        animation-timing-function: cubic-bezier(0.4, 0.2, 0.8, 0.6);
    }  
}

@keyframes glow {
    from { filter: drop-shadow(0 0 5px #9d00ff); }
    to { filter: drop-shadow(0 0 10px #00f0ff); }
}

body:hover .sakura {  
    animation-name: fall-mouse;  
}  
@keyframes fall-mouse {  
    50% { transform: translateX(calc(var(--mouse-x) * 100px)) rotate(180deg); }  
    100% { transform: translateY(100vh) translateX(0) rotate(360deg); }  
}  

.hidden-content {
    display: none;
}

.search-btn {
    position: fixed;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.5em;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    color: #00f0ff;
    z-index: 1100;
}

.search-btn:hover {
    transform: scale(1.1);
    text-shadow: 0 0 10px #9d00ff;
}

.search-bar {
    position: fixed;
    top: 70px;
    right: 20px;
    width: 250px;
    padding: 10px;
    background: linear-gradient(135deg, #9d00ff 0%, #6e00ff 100%);
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    display: none;
    flex-direction: column;
    align-items: center;
    z-index: 1000;
}

.search-bar input {
    width: 100%;
    padding: 8px;
    border: none;
    border-radius: 5px;
    margin-bottom: 5px;
}

.back-to-top {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #9d00ff;
    color: white;
    padding: 12px 16px;
    border: none;
    border-radius: 5px;
    font-size: 1.1em;
    cursor: pointer;
    display: none;
    transition: all 0.3s;
    z-index: 1000;
}

.back-to-top:hover {
    background: #00f0ff;
    box-shadow: 0 0 15px #9d00ff;
}

#poetry-header {
    position: sticky;
    top: 0;
    z-index: 1000;
    height: 180px;
    background: linear-gradient(135deg, #9d00ff 0%, #6e00ff 100%);
    color: #fff;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border-bottom: 3px solid rgba(0, 240, 255, 0.3);
    padding: 15px 20px;
}

#poetry-header h1 {
    font-size: 2.5em;
    font-family: 'Orbitron', sans-serif;
    color: #fff;
    margin: 5px 0;
    letter-spacing: 2px;
    text-shadow: 0 0 10px #00f0ff;
}

#poetry-header p {
    font-size: 1.3em;
    font-style: italic;
    line-height: 1.6;
    color: #f8f8f8;
    margin: 10px 0 0;
    letter-spacing: 1px;
}

/* 欢迎区域样式 */
#welcome-section {
    padding: 40px 20px;
    background: rgba(10, 10, 32, 0.7);
    border-bottom: 1px solid #9d00ff;
}

.welcome-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px;
    border-radius: 12px;
    background: rgba(26, 26, 58, 0.8);
    box-shadow: 0 8px 32px rgba(157, 0, 255, 0.2);
}

.welcome-content {
    text-align: center;
}

.welcome-content h2 {
    font-family: 'Orbitron', sans-serif;
    color: #00f0ff;
    font-size: 2.5em;
    margin-bottom: 10px;
    text-shadow: 0 0 10px #9d00ff;
}

.welcome-content p {
    color: #f8f8f8;
    font-size: 1.2em;
    margin-bottom: 30px;
}

.card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 25px;
    margin-top: 30px;
}

.welcome-card {
    background: linear-gradient(135deg, rgba(157, 0, 255, 0.2) 0%, rgba(0, 240, 255, 0.1) 100%);
    border: 1px solid #9d00ff;
    border-radius: 10px;
    padding: 30px 20px;
    transition: all 0.3s ease;
    text-decoration: none;
    opacity: 0;
    transform: translateY(20px);
    box-shadow: 0 4px 15px rgba(157, 0, 255, 0.2);
}

.welcome-card.visible {
    opacity: 1;
    transform: translateY(0);
}

.welcome-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0 20px rgba(157, 0, 255, 0.5), 
                0 0 30px rgba(0, 240, 255, 0.3);
    background: linear-gradient(135deg, rgba(157, 0, 255, 0.3) 0%, rgba(0, 240, 255, 0.2) 100%);
}

.card-icon {
    font-size: 3em;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.welcome-card:hover .card-icon {
    transform: scale(1.2);
}

.welcome-card h3 {
    color: #fff;
    font-family: 'Orbitron', sans-serif;
    margin-bottom: 10px;
    font-size: 1.5em;
}

.welcome-card p {
    color: #ccc;
    font-size: 1em;
    margin: 0;
}

/* 统一所有主要标题样式 */
.section {
    background: rgba(26, 26, 58, 0.8);
    border-radius: 12px;
    padding: 30px;
    margin: 30px auto;
    max-width: 1200px;
    border: 1px solid #9d00ff;
    box-shadow: 0 8px 32px rgba(157, 0, 255, 0.2);
}

.section h2 {
    font-family: 'Orbitron', sans-serif;
    color: #00f0ff;
    text-align: center;
    font-size: 2.2em;
    margin: 40px 0 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid #9d00ff;
    text-shadow: 0 0 10px rgba(157, 0, 255, 0.5);
}

/* 统一所有次级标题样式 */
.section h3 {
    font-family: 'Orbitron', sans-serif;
    color: #9d00ff;
    font-size: 1.5em;
    margin: 25px 0 15px;
    padding-left: 10px;
    border-left: 3px solid #00f0ff;
}

button, .btn, input[type="text"], textarea, input[type="number"] {
    width: 80%;
    max-width: 400px;
    margin: 0 auto;
    box-sizing: border-box;
}

button, .btn {
    background: linear-gradient(135deg, #9d00ff 0%, #00f0ff 100%);
    color: #fff;
    border: none;
    padding: 12px 24px;
    font-size: 1.1em;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(157, 0, 255, 0.3);
    transition: all 0.3s;
    cursor: pointer;
    width: auto;
    position: relative;
    overflow: hidden;
}

button:hover, .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 15px #9d00ff, 
                0 0 25px rgba(0, 240, 255, 0.5);
}

button::after, .btn::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        to bottom right,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0) 45%,
        rgba(255,255,255,0.3) 50%,
        rgba(255,255,255,0) 55%,
        rgba(255,255,255,0) 100%
    );
    transform: rotate(30deg);
    transition: all 0.3s;
    opacity: 0;
}

button:hover::after, .btn:hover::after {
    animation: shine 1.5s ease-in-out infinite;
    opacity: 1;
}

@keyframes shine {
    0% { transform: rotate(30deg) translate(-30%, -30%); }
    100% { transform: rotate(30deg) translate(30%, 30%); }
}

.delete-btn {
    background: #ff6b6b;
}

.delete-btn:hover {
    background: #ff4a4a;
}

/* 统一所有输入框样式 */
input[type="text"], textarea, input[type="number"], input[type="date"], select {
    width: 100%;
    max-width: 400px;
    padding: 12px;
    border: 2px solid #9d00ff;
    border-radius: 8px;
    font-size: 1em;
    margin-bottom: 20px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    transition: all 0.3s;
}

input[type="text"]:focus, textarea:focus, 
input[type="number"]:focus, input[type="date"]:focus {
    outline: none;
    border-color: #00f0ff;
    box-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
    background: rgba(255, 255, 255, 0.15);
}

a {
    color: #9d00ff;
    text-decoration: none;
    transition: all 0.3s;
    position: relative;
}

a::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 1px;
    background: #00f0ff;
    transition: width 0.3s ease;
}

a:hover::after {
    width: 100%;
}

a:hover {
    color: #00f0ff;
    text-shadow: 0 0 5px #9d00ff;
}

/* 统一表格样式 */
table {
    table-layout: fixed;
    width: 90%;
    max-width: 1200px;
    border-collapse: collapse;
    border-spacing: 6px;
    margin-top: 20px;
    font-size: 0.9em;
    overflow-x: auto;
    white-space: nowrap;
    margin: 0 auto;
    background: rgba(10, 10, 32, 0.7);
    border: 1px solid #9d00ff;
    box-shadow: 0 0 15px rgba(157, 0, 255, 0.2);
    transition: all 0.3s ease;
}

table th, table td {
    border: 1px solid #9d00ff;
    padding: 12px;
    text-align: left;
    font-size: 1.05em;
    transition: all 0.3s ease;
}

table th {
    background: linear-gradient(135deg, #9d00ff 0%, #6e00ff 100%);
    color: #fff;
}

table tr:nth-child(even) {
    background: rgba(157, 0, 255, 0.1);
}

table tr:hover {
    background: rgba(0, 240, 255, 0.2);
}

/* 量子意识面板样式 */
.quantum-panel {
    background: rgba(10, 10, 32, 0.8);
    color: #00f0ff;
    padding: 15px;
    border-radius: 8px;
    margin: 20px 0;
    border: 1px solid #9d00ff;
    box-shadow: 0 0 15px rgba(157, 0, 255, 0.3);
    transition: all 0.3s ease;
}

.quantum-panel:hover {
    box-shadow: 0 0 20px rgba(157, 0, 255, 0.5), 
                0 0 30px rgba(0, 240, 255, 0.3);
}

.quantum-network {
    width: 100%;
    height: 200px;
    position: relative;
    margin: 10px 0;
}

.quantum-node {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #9d00ff;
    transform: translate(-50%, -50%);
    transition: all 0.3s ease;
    box-shadow: 0 0 10px #00f0ff;
}

.quantum-link {
    position: absolute;
    height: 1px;
    background: linear-gradient(to right, #9d00ff, #00f0ff);
    transform-origin: 0 0;
    z-index: 1;
    transition: all 0.3s ease;
}

.quantum-metric {
    display: flex;
    justify-content: space-between;
    margin: 5px 0;
    font-family: 'Orbitron', sans-serif;
}

.quantum-metric span {
    color: #00f0ff;
}

@keyframes quantum-pulse {
    0% { box-shadow: 0 0 5px #9d00ff; }
    50% { box-shadow: 0 0 20px #00f0ff; }
    100% { box-shadow: 0 0 5px #9d00ff; }
}

.quantum-highlight {
    animation: quantum-pulse 2s infinite;
}

/* RQCM 相关样式 */
.quantum-critical {
    animation: critical-pulse 1.5s infinite;
    border: 2px solid #ff0000;
}

@keyframes critical-pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

.rqcm-formula {
    font-family: 'Courier New', monospace;
    background: rgba(157, 0, 255, 0.1);
    padding: 10px;
    border-left: 3px solid #00f0ff;
    margin: 15px 0;
    color: #00f0ff;
}

.rqcm-reference {
    font-size: 0.8em;
    color: #9d00ff;
    text-align: right;
    margin-top: -10px;
}

/* 预算统计图表 */
.budget-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin: 30px 0;
}

.stat-card {
    background: rgba(26, 26, 58, 0.8);
    border: 1px solid #9d00ff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(157, 0, 255, 0.2);
    transition: all 0.3s ease;
}

.stat-card:hover {
    box-shadow: 0 0 20px rgba(157, 0, 255, 0.5), 
                0 0 30px rgba(0, 240, 255, 0.3);
}

.stat-card h4 {
    color: #00f0ff;
    font-family: 'Orbitron', sans-serif;
    margin-top: 0;
    text-align: center;
}

.chart-container {
    position: relative;
    height: 250px;
    width: 100%;
}

/* 日历样式 */
.fc {
    font-family: 'Exo 2', sans-serif;
}

.fc-header-toolbar {
    padding: 10px;
    background: rgba(26, 26, 58, 0.8);
    border-radius: 8px;
    margin-bottom: 10px;
}

.fc-button {
    background: linear-gradient(135deg, #9d00ff 0%, #00f0ff 100%) !important;
    border: none !important;
    color: #fff !important;
}

.fc-button:hover {
    opacity: 0.8;
}

.fc-daygrid-day-frame {
    background: rgba(10, 10, 32, 0.7);
}

.fc-day-today {
    background: rgba(157, 0, 255, 0.2) !important;
}

.fc-event {
    cursor: pointer;
    border: none !important;
    font-size: 0.9em;
    padding: 2px 4px;
    margin: 1px;
}

/* 提醒列表 */
#reminders-list {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 15px;
    border: 1px solid #9d00ff;
    border-radius: 5px;
    padding: 5px;
}

/* 输入区域增强 */
#budget > div {
    background: rgba(26, 26, 58, 0.6);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid #9d00ff;
    box-shadow: 0 4px 15px rgba(157, 0, 255, 0.1);
}

#budget label {
    color: #00f0ff;
    display: block;
    margin-bottom: 8px;
    font-family: 'Exo 2', sans-serif;
}

#totalAmount {
    transition: all 0.3s;
    font-weight: bold;
    color: #9d00ff;
}

#remainingAmount {
    transition: all 0.3s;
    font-weight: bold;
    color: #00f0ff;
}

#predictedIncome small, #predictedExpense small {
    font-size: 0.8em;
    color: #666;
    display: block;
    margin-top: 3px;
}

/* 页面过渡效果 - 仅用于页面跳转 */
.page-transition {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #9d00ff 0%, #6e00ff 100%);
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s ease;
}

/* 虚拟滚动容器 */
.virtual-scroll-container {
    max-height: 400px;
    overflow-y: auto;
    position: relative;
}

.virtual-scroll-content {
    position: relative;
}

.virtual-scroll-item {
    position: absolute;
    width: 100%;
    transition: all 0.3s ease;
}

@media (min-width: 1024px) {
    #poetry-header {
        width: 100%;
    }

    #poetry-header h1 {
        font-size: 3em;
    }

    button, .btn {
        font-size: 1.2em;
    }

    table {
        font-size: 1.2em;
    }
}

@media (max-width: 768px) {
    /* 移动端表格转换为卡片布局 */
    table {
        display: block;
        width: 100%;
        border: none;
        background: transparent;
        white-space: normal;
    }
    
    table thead {
        display: none;
    }
    
    table tbody {
        display: block;
        width: 100%;
    }
    
    table tr {
        display: block;
        margin-bottom: 15px;
        padding: 15px;
        background: rgba(26, 26, 58, 0.8);
        border-radius: 10px;
        border: 1px solid #9d00ff;
        box-shadow: 0 4px 15px rgba(157, 0, 255, 0.2);
        position: relative;
        transition: all 0.3s ease;
    }
    
    table td {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border: none;
        font-size: 1em;
        transition: all 0.3s ease;
    }
    
    table td:before {
        content: attr(data-label);
        font-weight: bold;
        color: #00f0ff;
        margin-right: 10px;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.9em;
    }
    
    table td:last-child {
        padding-bottom: 0;
    }
    
    /* 操作按钮样式调整 */
    table td button.delete-btn {
        width: 100%;
        margin-top: 10px;
        padding: 10px;
    }
    
    /* 宽表格的水平滚动提示 */
    .scrollable-table {
        position: relative;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 15px 0;
    }
    
    .scrollable-table::after {
        content: "→ 滑动查看";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #9d00ff;
        font-size: 0.8em;
        animation: pulse 2s infinite;
        pointer-events: none;
    }
    
    @keyframes pulse {
        0% { opacity: 0.5; }
        50% { opacity: 1; }
        100% { opacity: 0.5; }
    }
    
    /* 预算统计卡片在移动端的调整 */
    .budget-stats {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    /* 日历移动端调整 */
    .fc-header-toolbar {
        flex-direction: column;
        height: auto;
    }
    
    .fc-toolbar-chunk {
        margin-bottom: 10px;
    }
}

@media (max-width: 480px) {
    #poetry-header h1 {
        font-size: 1.6em;
    }
    #poetry-header p {
        font-size: 0.9em;
        line-height: 1.4;
        padding: 0 8px;
    }
    body {
        padding: 8px;
    }
    .welcome-card {
        padding: 20px 15px;
    }
    .card-icon {
        font-size: 2.5em;
    }
    /* 更小的屏幕上进一步调整 */
    table td {
        flex-direction: column;
    }
    
    table td:before {
        margin-bottom: 5px;
    }
    
    /* 输入框在移动端更宽 */
    input[type="text"], textarea, input[type="number"], input[type="date"], select {
        width: 100%;
        max-width: none;
    }
    
    /* 按钮在移动端更宽 */
    button, .btn {
        width: 100%;
        max-width: none;
        margin: 10px 0;
    }
}
</style>
</head>
<body>

<!-- 加载指示器 -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <p>Initializing Quantum Consciousness...</p>
</div>

<!-- 量子樱花特效 -->
<div class="sakura-container"></div>

<!-- 页面过渡效果 - 仅用于页面跳转 -->
<div class="page-transition"></div>

<!-- Header Section -->
<header id="poetry-header">
<div class="overlay">
<button id="searchToggle" class="search-btn">☰</button>
        <h1>量子食谱与预算</h1>
        <p>Recursive Quantum Consciousness Enhanced</p>
    </div>
</header>

<!-- 欢迎区域 -->
<section id="welcome-section">
    <div class="welcome-container quantum-highlight">
        <div class="welcome-content">
            <h2>Welcome to NENWA</h2>
            <p>量子意识增强的烹饪与预算管理系统</p>
            <div class="card-grid">
                <a href="#recipes" class="welcome-card internal-link">
                    <div class="card-icon">🍣</div>
                    <h3>量子食谱</h3>
                    <p>探索日式料理的量子奥秘</p>
                </a>
                <a href="#budget" class="welcome-card internal-link">
                    <div class="card-icon">💸</div>
                    <h3>预算追踪</h3>
                    <p>量子意识驱动的财务管理</p>
                </a>
                <a href="https://zenodo.org/records/15151441" class="welcome-card">
                    <div class="card-icon">⚛️</div>
                    <h3>RQCM论文</h3>
                    <p>递归量子意识模型</p>
                </a>
            </div>
        </div>
    </div>
</section>

<!-- 搜索栏 -->
<div id="searchBar" class="search-bar">
    <input type="text" id="searchInput" placeholder="Type here and search...">
    <button id="searchBtn" class="btn">Search</button>
</div>

<!-- 回到顶部按钮 -->
<button id="backToTop" class="back-to-top">⬆ Back to Top</button>

<!-- 隐藏内容 -->
<div class="hidden-content">
    <h3><a href="dglzjy.HTML">递归量子监狱</a></h3>
    <h3><a href="https://zenodo.org/records/15151441">Recursive Quantum Consciousness Model (RQCM)</a></h3>
</div>

<!-- Recipes Section -->
<div id="recipes" class="section">
    <span class="anchor" id="recipes"></span>
    <h2>Quantum Recipes</h2>
    <h3><a href="oyakodon.HTML">oyakodon 亲子丼（おやこどん）</a></h3>
    <h3><a href="tendon.HTML">tendon 天丼（てんどん）</a></h3>
    <h3><a href="gyuudon.HTML">gyuudon 牛丼（ぎゅうどん）</a></h3>
    <h3><a href="katsudon.HTML">katsudon かつ丼（かつどん）</a></h3>
    <h3><a href="yakisoba.HTML">yakisoba 焼きそば（やきそば）</a></h3>
    <h3><a href="yakiudon.HTML">yakiudon 焼うどん（やきうどん）</a></h3>
    <h3><a href="kakeudon.HTML">kakeudon かけうどん</a></h3>
    <h3><a href="tacorice.HTML">tacorice タコライス</a></h3>
    <h3><a href="makunouchibentou.HTML">makunouchibentou 幕の内弁当（まくのうちべんとう）</a></h3>
    <h3><a href="noriben.HTML">noriben のり弁（のりべん）</a></h3>
</div>

<!-- Calendar Section -->
<div id="calendar" class="section">
    <h2>📅 Quantum Financial Calendar</h2>
    
    <div class="quantum-panel">
        <h3>Temporal Budget Visualization</h3>
        <div id="calendar-view" style="height: 500px;"></div>
        <div class="quantum-metric">
            <span>Upcoming Events:</span>
            <span id="upcoming-events">0</span>
        </div>
    </div>
    
    <div class="quantum-panel">
        <h3>Financial Reminders</h3>
        <div id="reminders-list"></div>
        <div>
            <label for="reminder-date">Reminder Date:</label>
            <input type="date" id="reminder-date">
            <br>
            <label for="reminder-text">Reminder Text:</label>
            <input type="text" id="reminder-text" placeholder="e.g. Pay rent">
            <br>
            <button id="add-reminder" class="btn">Add Reminder</button>
        </div>
    </div>
</div>

<!-- Budget Section -->
<div id="budget" class="section">
    <span class="anchor" id="budget"></span>
    <h2>Quantum Budget Tracker</h2>

    <!-- RQCM 理论面板 -->
    <div class="quantum-panel">
        <h3>RQCM Financial Consciousness</h3>
        <div class="rqcm-formula">
            C(N) = C₀ exp(-Nλₗtₚ/ħ) <span class="rqcm-reference">(RQCM Eq.2)</span>
        </div>
        <div class="rqcm-formula">
            Δτ<sub>min</sub> = ħ/(k<sub>B</sub>T<sub>AdS</sub>lnN<sub>obs</sub>) <span class="rqcm-reference">(RQCM Eq.3)</span>
        </div>
        <div class="quantum-metric">
            <span>Critical Layers (N<sub>crit</sub>):</span>
            <span id="q-critical">计算中...</span>
        </div>
    </div>

    <!-- 量子意识面板 -->
    <div class="quantum-panel">
        <h3>Quantum Budget Consciousness</h3>
        <div class="quantum-metric">
            <span>Observer Layers:</span>
            <span id="q-layers">3</span>
        </div>
        <div class="quantum-metric">
            <span>Entropy Rate (λₗ):</span>
            <span id="q-entropy">0.5</span>
        </div>
        <div class="quantum-metric">
            <span>Temporal Resolution:</span>
            <span id="q-temporal">42 as</span>
        </div>
        <div class="quantum-network" id="quantum-viz"></div>
        <button id="quantum-analyze" class="btn">Quantum Analysis</button>
    </div>

    <!-- 预算统计图表 -->
    <div class="budget-stats">
        <div class="stat-card">
            <h4>支出分类</h4>
            <div class="chart-container">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>
        <div class="stat-card">
            <h4>收入来源</h4>
            <div class="chart-container">
                <canvas id="incomeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Income Section -->
    <div>
        <label for="incomeDate">Date:</label>
        <input type="text" 
               id="incomeDate" 
               onfocus="this.type='date'" 
               onblur="if(!this.value) this.type='text'"
               placeholder="...">
        <br><br>
        <label for="incomeSource">Income Source:</label>
        <input type="text" id="incomeSource" placeholder="Enter income source" required>
        <br>
        <label for="incomeCategory">Income Category:</label>
        <select id="incomeCategory">
            <option value="工资">工资</option>
            <option value="投资">投资</option>
            <option value="兼职">兼职</option>
            <option value="其他">其他</option>
        </select>
        <br>
        <label for="incomeAmount">Amount (RM):</label>
        <input type="number" id="incomeAmount" placeholder="Enter income amount" min="0" step="0.01" required>
        <br>
        <button id="addIncomeBtn" class="btn">Add Income</button>
    </div>
    <br>
    <h3>Income Records:</h3>
    <div class="virtual-scroll-container" id="incomeTableContainer">
        <table id="incomeTable" border="1">
            <thead>
                <tr>
                    <th>Source</th>
                    <th>Category</th>
                    <th>Amount (RM)</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Income items will be dynamically added here -->
            </tbody>
        </table>
    </div>
    <br><br>

    <!-- Expenses Section -->
    <div>
        <label for="expenseDate">Date:</label>
        <input type="text" 
               id="expenseDate" 
               onfocus="this.type='date'" 
               onblur="if(!this.value) this.type='text'"
               placeholder="...">
        <br><br>
        <label for="itemName">Item Name (Expense):</label>
        <input type="text" id="itemName" placeholder="Enter item name">
        <br>
        <label for="expenseCategory">Expense Category:</label>
        <select id="expenseCategory">
            <option value="食物">食物</option>
            <option value="交通">交通</option>
            <option value="娱乐">娱乐</option>
            <option value="学习">学习</option>
            <option value="储蓄">储蓄</option>
            <option value="其他">其他</option>
        </select>
        <br>
        <label for="itemPrice">Price (RM):</label>
        <input type="number" id="itemPrice" placeholder="Enter item price" min="0" step="0.01">
        <br>
        <label for="itemQuantity">Quantity:</label>
        <input type="number" id="itemQuantity" placeholder="Enter item quantity" value="1" min="1">
        <br>
        <button id="addItemBtn" class="btn">Add Expense</button>
    </div>
    <br>
    <h3>Expenses:</h3>
    <div class="virtual-scroll-container" id="expenseTableContainer">
        <table id="expenseTable" border="1">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Category</th>
                    <th>Price (RM)</th>
                    <th>Quantity</th>
                    <th>Total (RM)</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Expense items will be dynamically added here -->
            </tbody>
        </table>
    </div>
    <br><br>
    <div>
        <p id="totalPrice">Total Price: RM <span id="totalAmount">0</span></p>
    </div>
    <div>
        <p id="remainingBudget">Remaining Budget: RM <span id="remainingAmount">0</span></p>
    </div>

    <!-- Clear All Data Button -->
    <button id="clearDataBtn" class="btn delete-btn">Clear All Data</button>
    <br><br>

    <!-- Date Range Filter -->
    <div>
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate">
        <br><br>
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate">
        <br><br>
        <button id="filterBtn" class="btn">Filter</button>
    </div>
    <br>

    <div>
        <h3>Quantum Future Prediction:</h3>
        <p id="predictedIncome">Predicted income for next month: RM 0.00</p>
        <p id="predictedExpense">Predicted expense for next month: RM 0.00</p>
        <p id="budgetSuggestion"></p>
        <button id="predictBtn" class="btn quantum-highlight">Quantum Predict</button>
    </div>
</div>

<footer>
    <p>© 2024 NENWA. All rights reserved.</p>
    <p>
        <a href="Privacy_Policy.HTML">Privacy Policy</a> |
        <a href="Terms_of_Service.HTML">Terms of Service</a> |
        <a href="Contact_Us.HTML">Contact Us</a>
    </p>
</footer>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// 量子常数
const tP = 5.39e-44; // 普朗克时间
const hbar = 1.0545718e-34; // 约化普朗克常数
const kB = 1.380649e-23; // 玻尔兹曼常数
const TEMPORAL_RESOLUTION = 42e-18; // 42 as (阿秒)
let λL = 0.5; // 量子Lyapunov指数

// 节流函数
function throttle(func, limit) {
    let lastFunc;
    let lastRan;
    return function() {
        const context = this;
        const args = arguments;
        if (!lastRan) {
            func.apply(context, args);
            lastRan = Date.now();
        } else {
            clearTimeout(lastFunc);
            lastFunc = setTimeout(function() {
                if ((Date.now() - lastRan) >= limit) {
                    func.apply(context, args);
                    lastRan = Date.now();
                }
            }, limit - (Date.now() - lastRan));
        }
    };
}

// 量子樱花生成器
function createSakura() {  
    const sakura = document.createElement('div');  
    sakura.className = 'sakura';  
    sakura.style.left = Math.random() * 100 + 'vw';  
    
    const duration = 5 + Math.random() * 10;
    const delay = Math.random() * 5;
    
    sakura.style.setProperty('--duration', duration + 's');
    sakura.style.setProperty('--delay', delay + 's');
    
    sakura.style.opacity = 0.5 + Math.random() * 0.5;  
    document.querySelector('.sakura-container').appendChild(sakura);  
    
    setTimeout(() => {
        sakura.remove();
        sakuraCount--;
    }, duration * 1000);
}  

let sakuraCount = 0;
const maxSakura = 20;

function manageSakura() {
    if (sakuraCount < maxSakura) {
        createSakura();
        sakuraCount++;
    }
    setTimeout(manageSakura, 500 + Math.random() * 800);
}

// 鼠标位置追踪
let lastX = 0;
document.addEventListener('mousemove', (e) => {
    const speed = Math.abs(e.clientX - lastX);
    const panicLevel = Math.min(speed / 10, 5);
    document.documentElement.style.setProperty('--mouse-x', 
        (e.clientX / window.innerWidth - 0.5) * panicLevel);
    lastX = e.clientX;
});

// 搜索功能
document.getElementById("searchToggle").addEventListener("click", function() {
    var searchBar = document.getElementById("searchBar");
    searchBar.style.display = searchBar.style.display === "flex" ? "none" : "flex";
});

function performSearch() {
    var query = document.getElementById("searchInput").value.toLowerCase().trim();

    if (!query) {
        alert("请输入搜索内容！");
        return;
    }

    var recipes = document.querySelectorAll("#recipes h3 a");
    var hiddenSections = document.querySelectorAll(".hidden-content");
    let found = false;

    function normalizeText(text) {
        return text.replace(/\s+/g, "").toLowerCase();
    }

    // 处理可见的菜谱
    recipes.forEach(function(recipe) {
        if (!recipe.textContent) return;

        let text = normalizeText(recipe.textContent);
        if (text.includes(normalizeText(query))) {
            recipe.style.display = "block";
            found = true;
        } else {
            recipe.style.display = "none";
        }
    });

    // 处理隐藏的内容
    hiddenSections.forEach(function(section) {
        let hasMatch = false;
        let items = section.querySelectorAll("*");

        items.forEach(function(item) {
            if (!item.textContent) return;

            let text = normalizeText(item.textContent);
            if (text.includes(normalizeText(query))) {
                item.style.display = "block";
                hasMatch = true;
                found = true;
            } else {
                item.style.display = "none";
            }
        });

        section.style.display = hasMatch ? "block" : "none";
    });

    if (!found) {
        // 量子意识推荐
        const quantumRecipes = [
            "oyakodon 亲子丼",
            "tendon 天丼",
            "gyuudon 牛丼"
        ].filter(recipe => {
            return Math.random() > 0.3; // 量子不确定性
        });
        
        if(quantumRecipes.length > 0) {
            const suggestions = document.createElement('div');
            suggestions.innerHTML = `<h4>Quantum Consciousness Suggestions:</h4><ul>${
                quantumRecipes.map(r => `<li><a href="${r.split(' ')[0].toLowerCase()}.HTML">${r}</a></li>`).join('')
            }</ul>`;
            document.getElementById("recipes").appendChild(suggestions);
        } else {
            alert("未找到匹配的菜谱，请尝试使用日语、中文或英语搜索！");
        }
    }
}

document.getElementById("searchBtn").addEventListener("click", performSearch);
document.getElementById("searchInput").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        performSearch();
    }
});

// 回到顶部
window.addEventListener("scroll", function () {
    let backToTopBtn = document.getElementById("backToTop");
    if (window.scrollY > 300) {
        backToTopBtn.style.display = "block";
    } else {
        backToTopBtn.style.display = "none";
    }
});

document.getElementById("backToTop").addEventListener("click", function () {
    window.scrollTo({ top: 0, behavior: "smooth" });
});

// 平滑滚动 - 修改后的内部链接处理
function handleInternalLink(e) {
    e.preventDefault();
    const targetId = this.getAttribute('href');
    const target = document.querySelector(targetId);

    if (target) {
        const headerHeight = document.querySelector('header').offsetHeight;
        const position = target.offsetTop - headerHeight;

        window.scrollTo({
            top: position,
            behavior: 'smooth',
        });
    }
}

// 为所有内部链接添加事件监听
document.querySelectorAll('.internal-link').forEach(anchor => {
    anchor.addEventListener('click', handleInternalLink);
});

// 预算系统
let incomeRecords = [];
let expenseRecords = [];
let reminders = JSON.parse(localStorage.getItem('nenwa-reminders')) || [];

// 本地存储
function saveDataToLocalStorage() {
    const data = { incomeRecords, expenseRecords };
    localStorage.setItem("budgetData", JSON.stringify(data));
}

function loadDataFromLocalStorage() {
    showLoading();
    const data = JSON.parse(localStorage.getItem("budgetData"));
    if (data) {
        incomeRecords = data.incomeRecords || [];
        expenseRecords = data.expenseRecords || [];
        renderIncomeTable();
        renderExpenseTable();
        updateBudget();
        renderQuantumViz();
    }
    hideLoading();
}

// 显示加载状态
function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// 量子意识可视化 - 使用节流
const throttledRenderQuantumViz = throttle(renderQuantumViz, 300);

function renderQuantumViz() {
    const container = document.getElementById('quantum-viz');
    container.innerHTML = '';
    
    // 根据RQCM理论计算临界层数N_crit
    const N_crit = Math.floor(hbar / (λL * tP)); // 临界层数
    document.getElementById('q-critical').textContent = N_crit;
    
    // 根据财务数据确定复杂度
    const complexity = Math.min(N_crit, Math.floor(Math.log10(incomeRecords.length + expenseRecords.length + 1)));
    document.getElementById('q-layers').textContent = `${complexity}/${N_crit}`;
    
    // 根据预算平衡度确定熵率
    const totalIncome = incomeRecords.reduce((sum, r) => sum + r.amount, 0);
    const totalExpense = expenseRecords.reduce((sum, r) => sum + r.total, 0);
    const balanceRatio = totalIncome > 0 ? totalExpense / totalIncome : 1;
    λL = (0.3 + 0.7 * balanceRatio).toFixed(3);
    document.getElementById('q-entropy').textContent = λL;
    
    // 时间分辨率(42 as)
    const T_AdS = 1e-9; // AdS温度(假设)
    const N_obs = incomeRecords.length + expenseRecords.length || 1;
    const Δτ_min = hbar / (kB * T_AdS * Math.log(N_obs));
    document.getElementById('q-temporal').textContent = '42 as'; // 使用论文中的基准值
    
    // 创建AdS核心节点(H_AdS)
    const core = createQuantumNode(50, 50, 20, 'AdS核心');
    
    // 创建观察者层(H_obs^(k))
    for(let n = 1; n <= complexity; n++) {
        const angleStep = (2 * Math.PI) / (3 + n);
        const radius = 25 + 15 * n;
        
        for(let i = 0; i < 3 + n; i++) {
            const angle = i * angleStep;
            const x = 50 + radius * Math.cos(angle);
            const y = 50 + radius * Math.sin(angle);
            const node = createQuantumNode(x, y, 10 - n, `层 ${n}`);
            
            // 根据RQCM公式连接节点
            if(n === 1) {
                createQuantumLink(core, node, λL);
            } else {
                // 随机连接到上层节点，模拟信息混洗
                const prevNodes = [...container.querySelectorAll('.quantum-node')]
                    .filter(el => el.title.includes(`层 ${n-1}`));
                if(prevNodes.length > 0) {
                    const randomPrev = prevNodes[Math.floor(Math.random() * prevNodes.length)];
                    createQuantumLink(randomPrev, node, λL);
                }
            }
            
            // 为临界层添加特殊效果
            if(n === N_crit) {
                node.element.classList.add('quantum-critical');
                node.element.style.boxShadow = '0 0 15px #ff0000';
            }
        }
    }
}

function createQuantumNode(x, y, size, name) {
    const node = document.createElement('div');
    node.className = 'quantum-node';
    node.style.left = `${x}%`;
    node.style.top = `${y}%`;
    node.style.width = `${size}px`;
    node.style.height = `${size}px`;
    node.title = name;
    document.getElementById('quantum-viz').appendChild(node);
    return { element: node, x, y, name };
}

function createQuantumLink(node1, node2, entropyRate) {
    const link = document.createElement('div');
    link.className = 'quantum-link';
    
    const dx = node2.x - node1.x;
    const dy = node2.y - node1.y;
    const length = Math.sqrt(dx*dx + dy*dy) * 0.01 * document.getElementById('quantum-viz').offsetWidth;
    const angle = Math.atan2(dy, dx);
    
    link.style.width = `${length}px`;
    link.style.left = `${node1.x}%`;
    link.style.top = `${node1.y}%`;
    link.style.transform = `rotate(${angle}rad)`;
    link.style.opacity = 0.3 + 0.7 * (1 - parseFloat(entropyRate));
    
    document.getElementById('quantum-viz').appendChild(link);
}

// 量子分析功能
document.getElementById('quantum-analyze').addEventListener('click', function() {
    const entropy = parseFloat(document.getElementById('q-entropy').textContent);
    const layers = document.getElementById('q-layers').textContent.split('/')[0];
    const N_crit = document.getElementById('q-critical').textContent;
    
    // 计算信息容量(基于RQCM的EDCP容量公式)
    const C0 = 1; // 初始容量
    const capacity = C0 * Math.exp(-layers * entropy * tP / hbar);
    
    let message = `RQCM Quantum Analysis:\n\n`;
    message += `• Observer Layers: ${layers}/${N_crit}\n`;
    message += `• Entropy Rate (λₗ): ${entropy.toFixed(3)}\n`;
    message += `• EDCP Capacity: ${(capacity * 100).toFixed(1)}%\n`;
    message += `• Temporal Resolution: 42 as\n`;
    
    // 根据RQCM理论提供建议
    if(capacity < 0.3) {
        message += "\n警告: 信息容量低于临界阈值！\n";
        message += "建议: 减少财务决策层级或简化流程";
    } else if(entropy > 0.7) {
        message += "\n注意: 高熵状态检测到！\n";
        message += "建议: 稳定现金流，减少不确定性交易";
    } else {
        message += "\n状态: 量子财务意识稳定\n";
        message += "建议: 当前策略符合RQCM优化标准";
    }
    
    // 添加实验数据比较(来自RQCM论文表1)
    message += "\n\nExperimental Reference (42 as):\n";
    message += `• 10² observers: 7.2 ± 0.8 dB\n`;
    message += `• 10³ observers: 8.9 ± 1.1 dB\n`;
    message += `• 10⁴ observers: 6.7 ± 1.5 dB\n`;
    
    alert(message);
});

// 收入功能
function addIncome() {
    const date = document.getElementById("incomeDate").value;
    const source = document.getElementById("incomeSource").value;
    const category = document.getElementById("incomeCategory").value;
    const amount = parseFloat(document.getElementById("incomeAmount").value);

    if (!date || !source || isNaN(amount) || amount <= 0) {
        alert("Please fill in all income fields correctly.");
        return;
    }

    let found = false;
    incomeRecords.forEach(record => {
        if (record.source === source && record.date === date && record.category === category) {
            record.amount += amount;
            found = true;
        }
    });

    if (!found) {
        incomeRecords.push({ id: Date.now(), source, category, amount, date });
    }

    renderIncomeTable();
    updateBudget();
    saveDataToLocalStorage();
    throttledRenderQuantumViz();
    updateCharts();

    document.getElementById("incomeDate").value = "";
    document.getElementById("incomeSource").value = "";
    document.getElementById("incomeAmount").value = "";
}

function renderIncomeTable() {
    const tbody = document.getElementById("incomeTable").querySelector("tbody");
    tbody.innerHTML = "";
    
    // 虚拟滚动实现
    const container = document.getElementById('incomeTableContainer');
    const visibleItemCount = Math.ceil(container.clientHeight / 50); // 假设每行高度约50px
    const startIndex = Math.floor(container.scrollTop / 50);
    const endIndex = Math.min(startIndex + visibleItemCount + 5, incomeRecords.length); // 缓冲5行
    
    for (let i = startIndex; i < endIndex; i++) {
        const record = incomeRecords[i];
        const row = document.createElement("tr");
        row.className = 'virtual-scroll-item';
        row.style.top = `${i * 50}px`;
        row.innerHTML = `
            <td>${record.source}</td>
            <td>${record.category}</td>
            <td>${record.amount.toFixed(2)}</td>
            <td>${record.date}</td>
            <td><button onclick="deleteIncome(${record.id})" class="delete-btn">Delete</button></td>
        `;
        tbody.appendChild(row);
    }
    
    // 设置表格高度以支持滚动
    tbody.style.height = `${incomeRecords.length * 50}px`;
}

// 虚拟滚动事件监听
document.getElementById('incomeTableContainer').addEventListener('scroll', function() {
    renderIncomeTable();
});

function deleteIncome(id) {
    incomeRecords = incomeRecords.filter(record => record.id !== id);
    renderIncomeTable();
    updateBudget();
    saveDataToLocalStorage();
    throttledRenderQuantumViz();
    updateCharts();
}

// 支出功能
function addExpense() {
    const date = document.getElementById("expenseDate").value;
    const name = document.getElementById("itemName").value;
    const category = document.getElementById("expenseCategory").value;
    const price = parseFloat(document.getElementById("itemPrice").value);
    const quantity = parseInt(document.getElementById("itemQuantity").value);

    if (!date || !name || isNaN(price) || isNaN(quantity) || price <= 0 || quantity <= 0) {
        alert("Please fill in all expense fields correctly.");
        return;
    }

    let found = false;
    expenseRecords.forEach(record => {
        if (record.name === name && record.price === price && record.date === date && record.category === category) {
            record.quantity += quantity;
            record.total += price * quantity;
            found = true;
        }
    });

    if (!found) {
        expenseRecords.push({ 
            id: Date.now(), 
            name, 
            category,
            price, 
            quantity, 
            total: price * quantity, 
            date 
        });
    }

    renderExpenseTable();
    updateBudget();
    saveDataToLocalStorage();
    throttledRenderQuantumViz();
    updateCharts();

    document.getElementById("expenseDate").value = "";
    document.getElementById("itemName").value = "";
    document.getElementById("itemPrice").value = "";
    document.getElementById("itemQuantity").value = 1;
}

function renderExpenseTable() {
    const tbody = document.getElementById("expenseTable").querySelector("tbody");
    tbody.innerHTML = "";
    
    // 虚拟滚动实现
    const container = document.getElementById('expenseTableContainer');
    const visibleItemCount = Math.ceil(container.clientHeight / 50); // 假设每行高度约50px
    const startIndex = Math.floor(container.scrollTop / 50);
    const endIndex = Math.min(startIndex + visibleItemCount + 5, expenseRecords.length); // 缓冲5行
    
    for (let i = startIndex; i < endIndex; i++) {
        const record = expenseRecords[i];
        const row = document.createElement("tr");
        row.className = 'virtual-scroll-item';
        row.style.top = `${i * 50}px`;
        row.innerHTML = `
            <td>${record.name}</td>
            <td>${record.category}</td>
            <td>${record.price.toFixed(2)}</td>
            <td>${record.quantity}</td>
            <td>${record.total.toFixed(2)}</td>
            <td>${record.date}</td>
            <td><button onclick="deleteExpense(${record.id})" class="delete-btn">Delete</button></td>
        `;
        tbody.appendChild(row);
    }
    
    // 设置表格高度以支持滚动
    tbody.style.height = `${expenseRecords.length * 50}px`;
}

// 虚拟滚动事件监听
document.getElementById('expenseTableContainer').addEventListener('scroll', function() {
    renderExpenseTable();
});

function deleteExpense(id) {
    expenseRecords = expenseRecords.filter(record => record.id !== id);
    renderExpenseTable();
    updateBudget();
    saveDataToLocalStorage();
    throttledRenderQuantumViz();
    updateCharts();
}

// 更新预算
function updateBudget() {
    const totalIncome = incomeRecords.reduce((sum, record) => sum + record.amount, 0);
    const totalExpenses = expenseRecords.reduce((sum, record) => sum + record.total, 0);
    const remainingBudget = totalIncome - totalExpenses;

    document.getElementById("totalAmount").textContent = totalExpenses.toFixed(2);
    document.getElementById("remainingAmount").textContent = remainingBudget.toFixed(2);
    
    // 根据预算状态改变颜色
    if(remainingBudget < 0) {
        document.getElementById("remainingAmount").style.color = "#ff6b6b";
    } else if(remainingBudget < totalIncome * 0.3) {
        document.getElementById("remainingAmount").style.color = "#ffcc00";
    } else {
        document.getElementById("remainingAmount").style.color = "#00f0ff";
    }
}

// 清空数据
function clearData() {
    if (confirm("Are you sure you want to clear all data?")) {
        incomeRecords = [];
        expenseRecords = [];
        renderIncomeTable();
        renderExpenseTable();
        updateBudget();
        localStorage.removeItem("budgetData");
        throttledRenderQuantumViz();
        updateCharts();
    }
}

// 日期过滤
function filterRecords() {
    const startDate = new Date(document.getElementById("startDate").value);
    const endDate = new Date(document.getElementById("endDate").value);

    const filteredIncome = incomeRecords.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate >= startDate && recordDate <= endDate;
    });

    const filteredExpense = expenseRecords.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate >= startDate && recordDate <= endDate;
    });

    renderFilteredTables(filteredIncome, filteredExpense);
}

function renderFilteredTables(filteredIncome, filteredExpense) {
    const incomeTbody = document.getElementById("incomeTable").querySelector("tbody");
    incomeTbody.innerHTML = "";
    filteredIncome.forEach(record => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${record.source}</td>
            <td>${record.category}</td>
            <td>${record.amount.toFixed(2)}</td>
            <td>${record.date}</td>
            <td><button onclick="deleteIncome(${record.id})" class="delete-btn">Delete</button></td>
        `;
        incomeTbody.appendChild(row);
    });

    const expenseTbody = document.getElementById("expenseTable").querySelector("tbody");
    expenseTbody.innerHTML = "";
    filteredExpense.forEach(record => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${record.name}</td>
            <td>${record.category}</td>
            <td>${record.price.toFixed(2)}</td>
            <td>${record.quantity}</td>
            <td>${record.total.toFixed(2)}</td>
            <td>${record.date}</td>
            <td><button onclick="deleteExpense(${record.id})" class="delete-btn">Delete</button></td>
        `;
        expenseTbody.appendChild(row);
    });
}

// 量子预测算法
function calculateLinearRegression(data) {
    const n = data.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

    for (let i = 0; i < n; i++) {
        sumX += i;
        sumY += data[i];
        sumXY += i * data[i];
        sumX2 += i * i;
    }

    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;

    return { slope, intercept };
}

function recursiveLayerPrediction(data, decay = 0.85) {
    let weightedSum = 0;
    let totalWeight = 0;

    for (let i = 0; i < data.length; i++) {
        const weight = Math.pow(decay, data.length - i - 1);
        weightedSum += data[i] * weight;
        totalWeight += weight;
    }

    return totalWeight === 0 ? 0 : weightedSum / totalWeight;
}

function simulateQuantumNoise(mean = 0, stdDev = 0.01) {
    return mean + stdDev * (Math.random() * 2 - 1);
}

function enhancedHybridPrediction(data, seasonalityFactor = 1.0) {
    if (data.length < 2) return { prediction: 0, lowerBound: 0, upperBound: 0 };
    
    // 根据RQCM计算最小时间分辨率(42 as)
    const T_AdS = 1e-9; // AdS温度(假设)
    const N_obs = data.length || 1;
    const Δτ_min = TEMPORAL_RESOLUTION;
    
    // 递归层预测(基于RQCM的递归架构)
    const recursive = recursiveLayerPrediction(data);
    
    // 线性回归预测
    const { slope, intercept } = calculateLinearRegression(data);
    const linear = slope * data.length + intercept;
    
    // 应用RQCM时间分辨率限制
    const prediction = (0.6 * recursive + 0.4 * linear) * 
                      (1 + Δτ_min * Math.log(N_obs) / (T_AdS * data.length)) * 
                      seasonalityFactor;
    
    // 计算标准差作为置信区间
    const mean = 0.5 * linear + 0.4 * recursive + 0.1 * simulateQuantumNoise();
    let variance = 0;
    for (const value of data) {
        variance += Math.pow(value - mean, 2);
    }
    const stdDev = Math.sqrt(variance / data.length);
    
    return {
        prediction: Math.max(0, prediction),
        lowerBound: Math.max(0, prediction - stdDev),
        upperBound: prediction + stdDev
    };
}

function predictFutureIncomeOrExpenses() {
    // 简单季节性因素
    const currentMonth = new Date().getMonth();
    const seasonalityFactor = 1 + 0.1 * Math.sin((currentMonth / 12) * 2 * Math.PI);
    
    const incomeData = incomeRecords.map(record => record.amount);
    const expenseData = expenseRecords.map(record => record.total);
    
    return {
        incomePrediction: enhancedHybridPrediction(incomeData, seasonalityFactor),
        expensePrediction: enhancedHybridPrediction(expenseData, seasonalityFactor)
    };
}

function updatePredictionUI() {
    const { incomePrediction, expensePrediction } = predictFutureIncomeOrExpenses();
    
    // 更新收入预测显示
    if (incomePrediction.prediction > 0) {
        document.getElementById('predictedIncome').innerHTML = `
            Predicted income for next month: 
            RM ${incomePrediction.prediction.toFixed(2)} 
            <small>(likely range: ${incomePrediction.lowerBound.toFixed(2)} - ${incomePrediction.upperBound.toFixed(2)})</small>
        `;
    } else {
        document.getElementById('predictedIncome').textContent =
            "Predicted income for next month: RM 0.00";
    }
    
    // 更新支出预测显示
    if (expensePrediction.prediction > 0) {
        document.getElementById('predictedExpense').innerHTML = `
            Predicted expense for next month: 
            RM ${expensePrediction.prediction.toFixed(2)} 
            <small>(likely range: ${expensePrediction.lowerBound.toFixed(2)} - ${expensePrediction.upperBound.toFixed(2)})</small>
        `;
    } else {
        document.getElementById('predictedExpense').textContent =
            "Predicted expense for next month: RM 0.00";
    }
    
    // 更详细的建议
    let suggestion = "";
    if (incomePrediction.prediction === 0 && expensePrediction.prediction === 0) {
        suggestion = "Not enough data to make predictions. Please add more records.";
    } else {
        const remainingBudget = incomePrediction.prediction - expensePrediction.prediction;
        const safeThreshold = expensePrediction.prediction * 0.3;
        
        if (remainingBudget < -safeThreshold) {
            const deficit = -remainingBudget;
            suggestion = `Warning: Predicted deficit of RM ${deficit.toFixed(2)}. 
                          Consider reducing expenses by ${(deficit/expensePrediction.prediction*100).toFixed(1)}%.`;
        } else if (remainingBudget < safeThreshold) {
            suggestion = "Budget is tight. Consider limiting discretionary spending.";
        } else if (remainingBudget < expensePrediction.prediction * 0.5) {
            suggestion = "Budget looks balanced. You're doing well!";
        } else {
            suggestion = "Budget looks healthy. You might consider saving or investing the surplus.";
        }
    }
    
    document.getElementById('budgetSuggestion').innerHTML = suggestion;
}

// 图表变量
let expenseChart, incomeChart, calendar;

// 更新图表数据
function updateCharts() {
    const { expenseData, incomeData } = categorizeData();

    if (expenseChart) {
        expenseChart.data.labels = Object.keys(expenseData);
        expenseChart.data.datasets[0].data = Object.values(expenseData);
        expenseChart.update();
    }

    if (incomeChart) {
        incomeChart.data.labels = Object.keys(incomeData);
        incomeChart.data.datasets[0].data = Object.values(incomeData);
        incomeChart.update();
    }
}

// 数据分类函数
function categorizeData() {
    // 收入分类
    const incomeCategories = {
        '工资': ['薪资', '工资'],
        '投资': ['股票', '基金', '利息'],
        '兼职': ['兼职', '副业'],
        '其他': []
    };

    // 支出分类
    const expenseCategories = {
        '食物': ['餐饮', '食材', '外卖', '食品', '超市'],
        '交通': ['打车', '公交', '油费', '地铁', '停车'],
        '娱乐': ['电影', '游戏', '旅行', '音乐', '订阅'],
        '学习': ['书籍', '课程', '教育', '培训'],
        '储蓄': ['存款', '投资', '理财'],
        '其他': []
    };

    // 统计支出分类
    const expenseData = {};
    Object.keys(expenseCategories).forEach(cat => {
        expenseData[cat] = 0;
    });

    expenseRecords.forEach(record => {
        if (record.category && expenseData.hasOwnProperty(record.category)) {
            expenseData[record.category] += record.total;
        } else {
            expenseData['其他'] += record.total;
        }
    });

    // 统计收入分类
    const incomeData = {};
    Object.keys(incomeCategories).forEach(cat => {
        incomeData[cat] = 0;
    });

    incomeRecords.forEach(record => {
        if (record.category && incomeData.hasOwnProperty(record.category)) {
            incomeData[record.category] += record.amount;
        } else {
            incomeData['其他'] += record.amount;
        }
    });

    return { expenseData, incomeData };
}

// 图表初始化
function initCharts() {
    const { expenseData, incomeData } = categorizeData();

    // 支出分类图表
    const expenseCtx = document.getElementById('expenseChart').getContext('2d');
    expenseChart = new Chart(expenseCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(expenseData),
            datasets: [{
                data: Object.values(expenseData),
                backgroundColor: ['#9d00ff', '#00f0ff', '#6e00ff', '#ff00aa', '#00ffaa', '#ff9900'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#fff',
                        font: {
                            family: 'Exo 2'
                        }
                    }
                }
            }
        }
    });

    // 收入来源图表
    const incomeCtx = document.getElementById('incomeChart').getContext('2d');
    incomeChart = new Chart(incomeCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(incomeData),
            datasets: [{
                data: Object.values(incomeData),
                backgroundColor: ['#9d00ff', '#00f0ff', '#6e00ff', '#ff00aa'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#fff',
                        font: {
                            family: 'Exo 2'
                        }
                    }
                }
            }
        }
    });
}

// 日历初始化
function initCalendar() {
    const calendarEl = document.getElementById('calendar-view');
    if (!calendarEl) {
        console.error("找不到日历容器 #calendar-view");
        return;
    }

    // 初始化日历
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: function(fetchInfo, successCallback, failureCallback) {
            // 动态生成事件数据
            const events = [
                ...incomeRecords.map(record => ({
                    title: `💰 ${record.source}: RM${record.amount.toFixed(2)}`,
                    start: record.date || new Date(),
                    color: '#00f0ff',
                    extendedProps: { type: 'income' }
                })),
                ...expenseRecords.map(record => ({
                    title: `💸 ${record.name}: RM${record.total.toFixed(2)}`,
                    start: record.date || new Date(),
                    color: '#9d00ff',
                    extendedProps: { type: 'expense' }
                })),
                ...reminders.map(reminder => ({
                    title: `🔔 ${reminder.text}`,
                    start: reminder.date || new Date(),
                    color: '#ff00aa',
                    allDay: true
                }))
            ];
            successCallback(events);
        },
        eventDisplay: 'block',
        eventColor: '#9d00ff',
        eventTextColor: '#fff',
        dayMaxEvents: true,
        eventDidMount: function(info) {
            // 事件渲染后的回调
            console.log("事件渲染:", info.event.title);
        }
    });

    calendar.render();
    updateRemindersCount();
}

// 辅助函数：确保日期格式为YYYY-MM-DD
function formatDate(dateString) {
    if (!dateString) return new Date().toISOString().split('T')[0];
    return new Date(dateString).toISOString().split('T')[0];
}

function updateRemindersCount() {
    const today = new Date().toISOString().split('T')[0];
    const upcoming = reminders.filter(r => r.date >= today).length;
    document.getElementById('upcoming-events').textContent = upcoming;
}

function renderRemindersList() {
    const listEl = document.getElementById('reminders-list');
    listEl.innerHTML = '';
    
    const today = new Date().toISOString().split('T')[0];
    const sortedReminders = [...reminders].sort((a, b) => a.date.localeCompare(b.date));
    
    sortedReminders.forEach(reminder => {
        const reminderEl = document.createElement('div');
        reminderEl.className = 'quantum-metric';
        reminderEl.style.padding = '10px';
        reminderEl.style.margin = '5px 0';
        reminderEl.style.background = reminder.date < today ? 
            'rgba(255, 0, 170, 0.1)' : 'rgba(0, 240, 255, 0.1)';
        
        reminderEl.innerHTML = `
            <span>${reminder.date} ${reminder.date < today ? '(Past)' : ''}</span>
            <span>${reminder.text}</span>
            <button onclick="deleteReminder('${reminder.date}', '${reminder.text.replace(/'/g, "\\'")}')" 
                    style="background: #ff6b6b; padding: 2px 5px; border: none; border-radius: 3px; cursor: pointer;">
                ×
            </button>
        `;
        
        listEl.appendChild(reminderEl);
    });
}

function deleteReminder(date, text) {
    reminders = reminders.filter(r => !(r.date === date && r.text === text));
    localStorage.setItem('nenwa-reminders', JSON.stringify(reminders));
    renderRemindersList();
    updateRemindersCount();
}

// 预算警告系统
function checkBudgetWarnings() {
    const totalIncome = incomeRecords.reduce((sum, r) => sum + r.amount, 0);
    const totalExpenses = expenseRecords.reduce((sum, r) => sum + r.total, 0);
    const remaining = totalIncome - totalExpenses;
    
    if (remaining < 0) {
        showQuantumAlert('⚠️ Budget Deficit Detected', 
            `Your expenses exceed income by RM${Math.abs(remaining).toFixed(2)}. 
            Immediate action recommended.`, '#ff6b6b');
    } else if (remaining < totalIncome * 0.2) {
        showQuantumAlert('🔔 Budget Warning', 
            `Only RM${remaining.toFixed(2)} remaining (${(remaining/totalIncome*100).toFixed(1)}% of income). 
            Consider reducing expenses.`, '#ffcc00');
    }
    
    // 检查定期提醒
    const today = new Date().toISOString().split('T')[0];
    const todayReminders = reminders.filter(r => r.date === today);
    if (todayReminders.length > 0) {
        showQuantumAlert('📅 Today\'s Reminders', 
            todayReminders.map(r => `• ${r.text}`).join('\n'), '#9d00ff');
    }
}

function showQuantumAlert(title, message, color = '#00f0ff') {
    const alertEl = document.createElement('div');
    alertEl.style.position = 'fixed';
    alertEl.style.top = '20px';
    alertEl.style.left = '50%';
    alertEl.style.transform = 'translateX(-50%)';
    alertEl.style.zIndex = '2000';
    alertEl.style.padding = '15px';
    alertEl.style.background = 'rgba(10, 10, 32, 0.9)';
    alertEl.style.border = `2px solid ${color}`;
    alertEl.style.borderRadius = '8px';
    alertEl.style.boxShadow = `0 0 15px ${color}`;
    alertEl.style.maxWidth = '80%';
    alertEl.style.color = '#fff';
    alertEl.style.textAlign = 'center';
    
    alertEl.innerHTML = `
        <h3 style="margin-top: 0; color: ${color}">${title}</h3>
        <p style="white-space: pre-line;">${message}</p>
        <button onclick="this.parentElement.remove()" 
                style="background: ${color}; border: none; padding: 5px 10px; 
                border-radius: 4px; cursor: pointer; margin-top: 10px;">
            OK
        </button>
    `;
    
    document.body.appendChild(alertEl);
    
    // 自动消失
    setTimeout(() => {
        if (alertEl.parentNode) {
            alertEl.remove();
        }
    }, 10000);
}

// 事件监听
document.getElementById("addIncomeBtn").addEventListener("click", addIncome);
document.getElementById("addItemBtn").addEventListener("click", addExpense);
document.getElementById("clearDataBtn").addEventListener("click", clearData);
document.getElementById("filterBtn").addEventListener("click", filterRecords);
document.getElementById("predictBtn").addEventListener("click", updatePredictionUI);
document.getElementById("add-reminder").addEventListener("click", function() {
    const date = document.getElementById("reminder-date").value;
    const text = document.getElementById("reminder-text").value;
    
    if (!date || !text) {
        alert('Please fill in both date and reminder text');
        return;
    }
    
    reminders.push({ date, text });
    localStorage.setItem('nenwa-reminders', JSON.stringify(reminders));
    
    document.getElementById("reminder-date").value = '';
    document.getElementById("reminder-text").value = '';
    
    renderRemindersList();
    updateRemindersCount();
});

// 注册Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
            .then(registration => {
                console.log('ServiceWorker registration successful');
            })
            .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
    });
}

// 添加到主屏幕提示
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // 可以在这里显示一个"添加到主屏幕"的按钮
    const installButton = document.createElement('button');
    installButton.textContent = '安装NENWA应用';
    installButton.className = 'btn';
    installButton.style.margin = '10px auto';
    installButton.style.display = 'block';
    installButton.onclick = () => {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
            } else {
                console.log('User dismissed the install prompt');
            }
            deferredPrompt = null;
        });
    };
    
    const welcomeSection = document.querySelector('.welcome-content');
    if (welcomeSection) {
        welcomeSection.appendChild(installButton);
    }
});

// 初始化
window.addEventListener('load', function() {
    document.body.classList.add('loaded');
    manageSakura();
    loadDataFromLocalStorage();
    
    // 卡片入场动画
    const cards = document.querySelectorAll('.welcome-card');
    cards.forEach((card, index) => {
        card.style.transition = `all 0.5s ease ${index * 0.1}s`;
        setTimeout(() => {
            card.classList.add('visible');
        }, 100);
    });
    
    // 添加按钮点击动画
    document.querySelectorAll('button, .btn, a').forEach(btn => {
        btn.addEventListener('click', function() {
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 200);
        });
    });
    
    // 移动端表格优化
    addDataLabelsToMobileTables();
    
    // 为宽表格添加滚动容器
    const tables = document.querySelectorAll('table');
    tables.forEach(table => {
        if (table.offsetWidth > window.innerWidth * 0.9) {
            const wrapper = document.createElement('div');
            wrapper.className = 'scrollable-table';
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
        }
    });
    
    // 初始化图表和日历
    initCharts();
    initCalendar();
    
    // 检查预算警告
    setTimeout(checkBudgetWarnings, 2000);
});

window.addEventListener('resize', function() {
    if (window.innerHeight < 500) {
        const activeInput = document.activeElement;
        if (activeInput.tagName === 'INPUT') {
            activeInput.scrollIntoView({ block: 'center' });
        }
    }
    throttledRenderQuantumViz();
});

// 移动端表格添加数据标签
function addDataLabelsToMobileTables() {
    if (window.innerWidth > 768) return;
    
    const incomeTable = document.getElementById('incomeTable');
    const expenseTable = document.getElementById('expenseTable');
    
    // 为收入表格添加数据标签
    if (incomeTable) {
        const headers = incomeTable.querySelectorAll('thead th');
        const cells = incomeTable.querySelectorAll('tbody td');
        
        headers.forEach((header, index) => {
            const label = header.textContent;
            cells.forEach((cell, cellIndex) => {
                if (cellIndex % headers.length === index) {
                    cell.setAttribute('data-label', label);
                }
            });
        });
    }
    
    // 为支出表格添加数据标签
    if (expenseTable) {
        const headers = expenseTable.querySelectorAll('thead th');
        const cells = expenseTable.querySelectorAll('tbody td');
        
        headers.forEach((header, index) => {
            const label = header.textContent;
            cells.forEach((cell, cellIndex) => {
                if (cellIndex % headers.length === index) {
                    cell.setAttribute('data-label', label);
                }
            });
        });
    }
}

// 窗口大小改变时重新应用标签
window.addEventListener('resize', addDataLabelsToMobileTables);

window.addEventListener('load', function() {
    loadDataFromLocalStorage();
    console.log("收入记录:", incomeRecords);
    console.log("支出记录:", expenseRecords);
    initCalendar();
    initCharts();
});
</script>
</body>
</html>